# 简介
NTP(Network Time Protocol）网络时间协议基于UDP，用于网络时间同步的协议，<br>
使网络中的计算机时钟同步到UTC，再配合各个时区的偏移调整就能实现精准同步对时功能。<br>
提供NTP对时的服务器有很多，比如微软的NTP对时服务器，<br>
利用NTP服务器提供的对时功能，可以使我们的设备时钟系统能够正确运行。<br>


# 网址
国内提供时间服务器的地址有：<br>

阿里云提供公共NTP服务，以下7个域名：
time1.aliyun.com
time2.aliyun.com
time3.aliyun.com
time4.aliyun.com
time5.aliyun.com
time6.aliyun.com
time7.aliyun.com

Windows服务器，或者使用ntpdate，那么可以直接使用
time.pool.aliyun.com

ping time1.aliyun.com


# 条件
网络正常，可以ping通该网址，也可百度其它网址<br>
ping time1.aliyun.com<br>

PS C:\Users\Administrator> ping time1.aliyun.com<br>

正在 Ping ntp.aliyun.com [203.107.6.88] 具有 32 字节的数据:<br>
来自 203.107.6.88 的回复: 字节=32 时间=34ms TTL=51<br>
来自 203.107.6.88 的回复: 字节=32 时间=33ms TTL=51<br>
来自 203.107.6.88 的回复: 字节=32 时间=33ms TTL=51<br>
来自 203.107.6.88 的回复: 字节=32 时间=32ms TTL=51<br>

203.107.6.88 的 Ping 统计信息:<br>
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，<br>
往返行程的估计时间(以毫秒为单位):<br>
    最短 = 32ms，最长 = 34ms，平均 = 33ms<br>
PS C:\Users\Administrator><br>

# 报文格式

格式<br>
    2     5     8                 16                24              31<br>
0 1 2 3 4 5 6 7 8 0 1 2 3 4 5 6 7 8 0 1 2 3 4 5 6 7 8 0 1 2 3 4 5 6 7 <br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ <br>
|LI | VN  |MODE |stratum         |Poll              |Precision      | <br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             根延迟            8bit    Root Delay                  |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             根差量           8bit     Root Dispersion             |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             参考时钟标识符   8bit      Reference Identifier        |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             参考时间戳       64bit     Reference Timestamp         |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             原始时间戳       64bit     Originate Timestamp         |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             接受时间戳       64bit     Receive Timestamp           |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             传送时间戳       64bit     Transmit Timestamp          |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>
|             认证符（可选项） 96bit      Authenticator               |<br>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>


# NTP报文格式解析
    LI 闰秒标识器，占用2个bit,值为“11”时表示告警状态，时钟未被同步。为其他值时NTP本身不做处理。
        0       无预告
        1       最近一分钟有61秒
        2       最近一分钟有59秒
        3       警告状态（时钟未同步）

    VN 版本号，占用3个bits，表示NTP的版本号，现在为3

    Mode 模式，占用3个bits，表示模式,不同的值所表示的含义分别是：
        0未定义、1表示主动对等体模式、2表示被动对等体模式、3表示客户模式、4表示服务器模式、
        5表示广播模式或组播模式、6表示此报文为NTP控制报文、7预留给内部使用。

    stratum（层），占用8个bits,系统时钟的层数，取值范围为1～16，它定义了时钟的准确度。层数为1的时钟准确度最高，
        准确度从1到16依次递减，层数为16的时钟处于未同步状态，不能作为参考时钟。
        0           未定义或难以获得
        1           主要参考（如无线电时钟钟，校正的院子时钟）
        2-255       第二参考（通过NTP或SNTP）

    Poll 测试间隔，占用8个bits，表示连续信息之间的最大间隔

    Precision 精度，占用8个bits，，表示本地时钟精度

    Root Delay 根时延，占用8个bits，表示在主参考源之间往返的总共时延

    Root Dispersion 根离散，占用8个bits，表示在主参考源有关的名义错误

    Reference Identifier 参考时钟标识符，占用8个bits，用来标识特殊的参考源  

    Reference Timestamp 参考时间戳，64bits时间戳，本地时钟被修改的最新时间。

    Originate Timestamp 原始时间戳，客户端发送的时间，64bits。

    Receive Timestamp 接受时间戳，服务端接受到的时间，64bits。

    Transmit Timestamp 传送时间戳，服务端送出应答的时间，64bits。

    Authenticator 认证符（可选项） 验证信息

```
                      t1  t2
server -----------------------------------------
                   -->       -->
                -->             -->
             -->                   -->
client -----------------------------------------
         t0                           t3
```

抛开复杂的协议报文，我们来理解一下NTP客户端与服务器的交互过程，<br>
进而理解参考时间戳、原始时间戳、接受时间戳、传送时间戳的关系。<br>
如图，客户端和服务端都有一个时间轴，分别代表着各自系统的时间，<br>
当客户端想要同步服务端的时间时，客户端会构造一个NTP协议包发送到NTP服务端，客户端会记下此时发送的时间t0，<br>
经过一段网络延时传输后，服务器在t1时刻收到数据包，<br>
经过一段时间处理后在t2时刻向客户端返回数据包，<br>
再经过一段网络延时传输后客户端在t3时刻收到NTP服务器数据包。<br>
特别声明，t0和t3是客户端时间系统的时间、t1和t2是NTP服务端时间系统的时间，<br>
它们是有区别的。对于时间要求不那么精准设备，直接使用NTP服务器返回t2时间也没有太大影响。<br>
但是作为一个标准的通信协议，它是精益求精且容不得过多误差的，于是必须计算上网络的传输延时。<br>
客户端与服务端的时间系统的偏移定义为θ、网络的往返延迟定义为δ，<br>
基于此，可以对t2进行精确的修正，已达到相关精度要求，它们的计算公式如下：<br>
```
    (t1-t0)+(t3-t2)
θ = ―――――――――――――――
           2
```
δ = (t3-t0)-(t2-t1)<br>

# 工作模式
设备可以采用多种NTP工作模式进行时间同步：<br>
    1.客户端/服务器模式<br>
    2.对等体模式<br>
    3.广播模式<br>
    4.组播模式<br>

用户可以根据需要选择合适的工作模式。<br>
在不能确定服务器或对等体IP地址、网络中需要同步的设备很多等情况下，可以通过广播或组播模式实现时钟同步；<br>
客户端/服务器和对等体模式中，设备从指定的服务器或对等体获得时钟同步，增加了时钟的可靠性。<br>

## 1. 客户端/服务器模式
在客户端/服务器模式中，客户端向服务器发送时钟同步报文，报文中的Mode字段设置为3（客户模式）。<br>
服务器端收到报文后会自动工作在服务器模式，并发送应答报文，报文中的Mode字段设置为4（服务器模式）。<br>
客户端收到应答报文后，进行时钟过滤和选择，并同步到优选的服务器。<br>

在该模式下，客户端能同步到服务器，而服务器无法同步到客户端。<br>

## 2. 对等体模式
 在对等体模式中，主动对等体和被动对等体之间首先交互Mode字段为3（客户端模式）和4（服务器模式）的NTP报文。<br>
 之后，主动对等体向被动对等体发送时钟同步报文，报文中的Mode字段设置为1（主动对等体），<br>
 被动对等体收到报文后自动工作在被动对等体模式，并发送应答报文，报文中的Mode字段设置为2（被动对等体）。<br>
 经过报文的交互，对等体模式建立起来。主动对等体和被动对等体可以互相同步。<br>

 如果双方的时钟都已经同步，则以层数小的时钟为准<br>

## 3. 广播模式
在广播模式中，服务器端周期性地向广播地址255.255.255.255发送时钟同步报文，报文中的Mode字段设置为5（广播模式）。<br>
客户端侦听来自服务器的广播报文。<br>
当客户端接收到第一个广播报文后，客户端与服务器交互Mode字段为3（客户模式）和4（服务器模式）的NTP报文，<br>
以获得客户端与服务器间的网络延迟。<br>
之后，客户端就进入广播客户端模式，继续侦听广播报文的到来，根据到来的广播报文对系统时钟进行同步。<br>

## 4. 组播模式
在组播模式中，服务器端周期性地向用户配置的组播地址（若用户没有配置组播地址，则使用默认的NTP组播地址224.0.1.1）<br>
发送时钟同步报文，报文中的Mode字段设置为5（组播模式）。<br>
客户端侦听来自服务器的组播报文。<br>
当客户端接收到第一个组播报文后，客户端与服务器交互Mode字段为3（客户模式）和4（服务器模式）的NTP报文，<br>
以获得客户端与服务器间的网络延迟。<br>
之后，客户端就进入组播客户模式，继续侦听组播报文的到来，根据到来的组播报文对系统时钟进行同步。<br>

# 实现
ntp网址是一个一直开启的服务器,默认端口为UDP 123<br>
通过客户端去访问它<br>
发送ntp请求，获取时间<br>
NTP时间同步报文中包含的时间是格林威治时间，是从1900年开始计算的秒数。<br>
